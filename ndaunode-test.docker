# Build stage: this all gets discarded later
FROM golang:1.10-alpine3.7

# Allow us to pass in a flag for CI builds
ARG CI
ENV CI=$CI

# start by installing fundamental utilities
# openssh-client is required for git
# git is required for glide
# bash is required for check-github-fingerprint.sh (array syntax)
RUN apk add --no-cache git openssh-client bash

ARG SSH_KEY_FILE="github_chaos_deploy"
COPY ${SSH_KEY_FILE} /root/.ssh/id_rsa
COPY ./bin/check-github-fingerprint.sh /root/
RUN /root/check-github-fingerprint.sh
RUN chmod 0600 /root/.ssh/*

# now install glide, which both tendermint and ndev-developed software
# use for dependency management
RUN go get github.com/Masterminds/glide

# Copy the context into the container and build the chaos application
ENV NDAU=$GOPATH/src/github.com/oneiro-ndev/ndau
COPY ./pkg ${NDAU}/pkg
COPY ./cmd ${NDAU}/cmd
COPY ./glide.* ${NDAU}/
WORKDIR ${NDAU}
# note the concatenated command here. This is a special case:
# we want to be absolutely sure that "glide install" doesn't use a cached version
# when we build the app, so we &&-concatenate the commands.
RUN glide install && \
    go test ./...
